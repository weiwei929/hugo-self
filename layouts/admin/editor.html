<!DOCTYPE html>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hugo-Self Markdownç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e1e8ed;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 1.5em;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .editor-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            padding: 1rem;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #f3f4f6;
        }

        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-pane, .preview-pane {
            flex: 1;
            overflow: auto;
        }

        .editor-pane {
            border-right: 1px solid #e1e8ed;
        }

        #markdown-editor {
            width: 100%;
            height: 100%;
            border: none;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .preview-pane {
            padding: 1rem;
            background-color: #fafbfc;
        }

        .file-item {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .file-item:hover {
            background-color: #f3f4f6;
        }

        .file-item.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .file-name {
            font-size: 0.9em;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .status-badge {
            font-size: 0.7em;
            padding: 0.2rem 0.4rem;
            border-radius: 12px;
            background-color: #e5e7eb;
            color: #374151;
        }

        .status-badge.published {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-badge.draft {
            background-color: #fef3c7;
            color: #92400e;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            min-width: 400px;
            max-width: 90%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            min-height: 38px;
        }

        .tag {
            background-color: #3b82f6;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-pane {
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ“ Markdownç¼–è¾‘å™¨</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showMetadataModal()">ğŸ“‹ å…ƒæ•°æ®</button>
            <button class="btn btn-primary" onclick="saveDocument()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-success" onclick="publishDocument()">ğŸš€ å‘å¸ƒ</button>
            <button class="btn btn-secondary" onclick="logout()">ğŸšª é€€å‡º</button>
            <a href="/admin/" class="btn btn-secondary">â† è¿”å›</a>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <div class="main-content">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h3>ğŸ“ æ–‡æ¡£åˆ—è¡¨</h3>
            
            <!-- åˆ é™¤è¿™ä¸¤è¡Œ -->
            <!-- æ·»åŠ åˆ›å»ºæ–°æ–‡æ¡£æŒ‰é’® -->
            <button class="btn btn-primary" onclick="createNewDocument()" style="width: 100%; margin-bottom: 1rem;">ğŸ“ åˆ›å»ºæ–°æ–‡æ¡£</button>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                <p>ğŸ“¤ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶</p>
                <p style="font-size: 0.8em; color: #6b7280;">æ”¯æŒ .md, .markdown, .txt</p>
                <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                    <div style="background: #e5e7eb; border-radius: 4px; height: 4px; overflow: hidden;">
                        <div id="progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="upload-status" style="font-size: 0.7em; color: #4b5563; margin-top: 0.25rem;">ä¸Šä¼ ä¸­...</p>
                </div>
            </div>
            <input type="file" id="file-upload" multiple accept=".md,.markdown,.txt" style="display: none;">

            <!-- æ–‡æ¡£åˆ—è¡¨ -->
            <div id="document-list">
                <!-- åŠ¨æ€åŠ è½½æ–‡æ¡£åˆ—è¡¨ -->
            </div>
        </div>

        <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
        <div class="editor-area">
            <!-- å·¥å…·æ  -->
            <div class="editor-toolbar">
                <button class="toolbar-btn" onclick="insertText('# ')" title="æ ‡é¢˜">H1</button>
                <button class="toolbar-btn" onclick="insertText('## ')" title="å‰¯æ ‡é¢˜">H2</button>
                <button class="toolbar-btn" onclick="insertText('**', '**')" title="ç²—ä½“">B</button>
                <button class="toolbar-btn" onclick="insertText('*', '*')" title="æ–œä½“">I</button>
                <button class="toolbar-btn" onclick="insertText('`', '`')" title="ä»£ç ">Code</button>
                <button class="toolbar-btn" onclick="insertText('[', ']()')" title="é“¾æ¥">ğŸ”—</button>
                <button class="toolbar-btn" onclick="showImageModal()" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>
                <button class="toolbar-btn" onclick="insertText('- ')" title="åˆ—è¡¨">List</button>
                <button class="toolbar-btn" onclick="insertText('> ')" title="å¼•ç”¨">Quote</button>
                <button class="toolbar-btn" onclick="togglePreview()" title="åˆ‡æ¢é¢„è§ˆ">ğŸ‘ï¸</button>
            </div>

            <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
            <div class="editor-container">
                <div class="editor-pane">
                    <textarea id="markdown-editor" placeholder="åœ¨æ­¤è¾“å…¥Markdownå†…å®¹..."></textarea>
                </div>
                <div class="preview-pane" id="preview-pane">
                    <p style="color: #6b7280;">é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å…ƒæ•°æ®æ¨¡æ€æ¡† -->
    <div id="metadata-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“‹ æ–‡æ¡£å…ƒæ•°æ®</h3>
            <form id="metadata-form">
                <div class="form-group">
                    <label for="doc-title">æ ‡é¢˜</label>
                    <input type="text" id="doc-title" required>
                </div>
                <div class="form-group">
                    <label for="doc-description">æè¿°</label>
                    <textarea id="doc-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="doc-tags">æ ‡ç­¾</label>
                    <div class="tag-input" id="tag-input">
                        <input type="text" id="tag-input-field" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦">
                    </div>
                </div>
                <div class="form-group">
                    <label for="doc-category">åˆ†ç±»</label>
                    <select id="doc-category">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                        <option value="æŠ€æœ¯">æŠ€æœ¯</option>
                        <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
                        <option value="æ€è€ƒ">æ€è€ƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doc-draft"> ä¿å­˜ä¸ºè‰ç¨¿
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('metadata-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜å…ƒæ•°æ®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å›¾ç‰‡æ’å…¥æ¨¡æ€æ¡† -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ–¼ï¸ æ’å…¥å›¾ç‰‡</h3>
            <form id="image-form">
                <div class="form-group">
                    <label>é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
                    <input type="file" id="image-upload" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="image-alt">å›¾ç‰‡æè¿°</label>
                    <input type="text" id="image-alt" placeholder="å›¾ç‰‡çš„æ›¿ä»£æ–‡å­—">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('image-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ’å…¥å›¾ç‰‡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentDocument = null;
        let documents = [];
        let isPreviewMode = false;
        const API_BASE = 'http://localhost:8081'; // APIæœåŠ¡å™¨åœ°å€ï¼ˆä¿®å¤ä¸º8081ç«¯å£ï¼‰
        const AUTH_KEY = 'hugo_self_auth';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const auth = localStorage.getItem(AUTH_KEY);
            if (!auth) {
                redirectToLogin();
                return false;
            }

            try {
                const authData = JSON.parse(auth);
                if (Date.now() >= authData.expiry) {
                    logout(false); // é™é»˜é€€å‡º
                    return false;
                }
                return true;
            } catch (e) {
                localStorage.removeItem(AUTH_KEY);
                redirectToLogin();
                return false;
            }
        }

        // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        function redirectToLogin() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2em;
                z-index: 10000;
            `;
            overlay.innerHTML = '<div>ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...</div>';
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1500);
        }

        // é€€å‡ºç™»å½•
        function logout(showConfirm = true) {
            if (showConfirm && !confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¼šä¸¢å¤±ï¼')) {
                return;
            }
            
            // æ¸…é™¤æ‰€æœ‰è®¤è¯ç›¸å…³æ•°æ®
            localStorage.removeItem(AUTH_KEY);
            sessionStorage.clear();
            
            // æ˜¾ç¤ºé€€å‡ºæˆåŠŸä¿¡æ¯
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5em;
                z-index: 10000;
            `;
            overlay.innerHTML = '<div>âœ… å·²å®‰å…¨é€€å‡ºï¼Œæ­£åœ¨è·³è½¬...</div>';
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1500);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!checkAuth()) {
                return;
            }
            
            loadDocuments();
            setupEventListeners();
            
            // è‡ªåŠ¨ä¿å­˜
            setInterval(autoSave, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
            
            // å®šæœŸæ£€æŸ¥ç™»å½•çŠ¶æ€
            setInterval(checkAuth, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            
            // ç¼–è¾‘å™¨å†…å®¹å˜åŒ–
            document.getElementById('markdown-editor').addEventListener('input', function() {
                if (!isPreviewMode) {
                    updatePreview();
                }
            });

            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // æ ‡ç­¾è¾“å…¥
            document.getElementById('tag-input-field').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // å…ƒæ•°æ®è¡¨å•æäº¤
            document.getElementById('metadata-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveMetadata();
                closeModal('metadata-modal');
            });

            // å›¾ç‰‡è¡¨å•æäº¤
            document.getElementById('image-form').addEventListener('submit', function(e) {
                e.preventDefault();
                insertImage();
                closeModal('image-modal');
            });
        }

        // åŠ è½½æ–‡æ¡£åˆ—è¡¨
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/api/documents`);
                const result = await response.json();
                
                if (result.success) {
                    documents = result.data;
                    renderDocumentList();
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡æ¡£
                    if (documents.length > 0) {
                        loadDocument(documents[0]);
                    }
                } else {
                    console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', result.error);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    documents = [
                        { id: 'demo1', title: 'æ¬¢è¿ä½¿ç”¨Hugo-Self', status: 'published', content: '# æ¬¢è¿ä½¿ç”¨Hugo-Self\n\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æ¡£ã€‚' },
                        { id: 'demo2', title: 'æ–°å»ºæ–‡æ¡£', status: 'draft', content: '# æ–°å»ºæ–‡æ¡£\n\nå¼€å§‹ç¼–å†™æ‚¨çš„å†…å®¹...' }
                    ];
                    renderDocumentList();
                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡æ¡£
                    if (documents.length > 0) {
                        loadDocument(documents[0]);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                documents = [
                    { id: 'demo1', title: 'æ¬¢è¿ä½¿ç”¨Hugo-Self', status: 'published', content: '# æ¬¢è¿ä½¿ç”¨Hugo-Self\n\nè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡æ¡£ã€‚' },
                    { id: 'demo2', title: 'æ–°å»ºæ–‡æ¡£', status: 'draft', content: '# æ–°å»ºæ–‡æ¡£\n\nå¼€å§‹ç¼–å†™æ‚¨çš„å†…å®¹...' }
                ];
                renderDocumentList();
                // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡æ¡£
                if (documents.length > 0) {
                    loadDocument(documents[0]);
                }
            }
        }

        // æ¸²æŸ“æ–‡æ¡£åˆ—è¡¨
        function renderDocumentList() {
            const listElement = document.getElementById('document-list');
            listElement.innerHTML = '';

            documents.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'file-item';
                if (currentDocument && currentDocument.id === doc.id) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <div class="file-name" title="${doc.title}">${doc.title}</div>
                    <span class="status-badge ${doc.status}">${doc.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}</span>
                `;
                
                item.addEventListener('click', () => loadDocument(doc));
                listElement.appendChild(item);
            });
        }

        // åŠ è½½æ–‡æ¡£
        function loadDocument(doc) {
            currentDocument = doc;
            document.getElementById('markdown-editor').value = doc.content || '';
            updatePreview();
            renderDocumentList(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const files = event.target.files;
            handleFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        async function handleFiles(files) {
            if (files.length === 0) return;
            
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('upload-status');
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            progressDiv.style.display = 'block';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                
                progressBar.style.width = progress + '%';
                statusText.textContent = `æ­£åœ¨å¤„ç†: ${file.name} (${i + 1}/${files.length})`;
                
                if (file.type === 'text/markdown' || file.type === 'text/plain' || file.name.endsWith('.md')) {
                    try {
                        const content = await file.text();
                        
                        // é€šè¿‡APIå¯¼å…¥æ–‡æ¡£
                        const response = await fetch(`${API_BASE}/api/documents/import`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filename: file.name,
                                content: content
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            successCount++;
                            console.log(`æ–‡æ¡£ "${file.name}" ä¸Šä¼ æˆåŠŸ`);
                        } else {
                            errorCount++;
                            console.error(`æ–‡æ¡£ "${file.name}" ä¸Šä¼ å¤±è´¥: ${result.error}`);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
                    }
                } else {
                    errorCount++;
                    console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.name}`);
                }
            }
            
            // å®Œæˆåæ˜¾ç¤ºç»“æœ
            progressBar.style.width = '100%';
            if (errorCount === 0) {
                statusText.textContent = `âœ… æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸ! (æˆåŠŸ: ${successCount}ä¸ª)`;
                statusText.style.color = '#065f46';
            } else if (successCount === 0) {
                statusText.textContent = `âŒ æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¤±è´¥! (å¤±è´¥: ${errorCount}ä¸ª)`;
                statusText.style.color = '#dc2626';
            } else {
                statusText.textContent = `âš ï¸ éƒ¨åˆ†æˆåŠŸ (æˆåŠŸ: ${successCount}ä¸ª, å¤±è´¥: ${errorCount}ä¸ª)`;
                statusText.style.color = '#d97706';
            }
            
            // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨
            if (successCount > 0) {
                await loadDocuments();
            }
            
            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
                statusText.style.color = '#4b5563';
            }, 3000);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            document.getElementById('file-upload').value = '';
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const content = document.getElementById('markdown-editor').value;
            const preview = document.getElementById('preview-pane');
            
            // ç®€å•çš„Markdownè½¬HTML (å®é™…é¡¹ç›®ä¸­å»ºè®®ä½¿ç”¨ä¸“é—¨çš„åº“)
            let html = content
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            if (html) {
                preview.innerHTML = '<p>' + html + '</p>';
            } else {
                preview.innerHTML = '<p style="color: #6b7280;">é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>';
            }
        }

        // æ’å…¥æ–‡æœ¬
        function insertText(before, after = '') {
            const editor = document.getElementById('markdown-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            
            const newText = before + selectedText + after;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            
            // è®¾ç½®å…‰æ ‡ä½ç½®
            const newCursorPos = start + before.length + selectedText.length;
            editor.setSelectionRange(newCursorPos, newCursorPos);
            editor.focus();
            
            updatePreview();
        }

        // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            const editorPane = document.querySelector('.editor-pane');
            const previewPane = document.querySelector('.preview-pane');
            
            if (isPreviewMode) {
                editorPane.style.display = 'none';
                previewPane.style.flex = '1';
            } else {
                editorPane.style.display = 'block';
                previewPane.style.flex = '1';
            }
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMetadataModal() {
            if (currentDocument) {
                document.getElementById('doc-title').value = currentDocument.title || '';
                document.getElementById('doc-description').value = currentDocument.description || '';
                // åŠ è½½æ ‡ç­¾å’Œåˆ†ç±»...
            }
            showModal('metadata-modal');
        }

        function showImageModal() {
            showModal('image-modal');
        }

        // æ·»åŠ æ ‡ç­¾
        function addTag(tagName) {
            if (tagName && !document.querySelector(`[data-tag="${tagName}"]`)) {
                const tagInput = document.getElementById('tag-input');
                const inputField = document.getElementById('tag-input-field');
                
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.setAttribute('data-tag', tagName);
                tag.innerHTML = `${tagName} <span class="tag-remove" onclick="removeTag('${tagName}')">Ã—</span>`;
                
                tagInput.insertBefore(tag, inputField);
            }
        }

        // ç§»é™¤æ ‡ç­¾
        function removeTag(tagName) {
            const tag = document.querySelector(`[data-tag="${tagName}"]`);
            if (tag) {
                tag.remove();
            }
        }

        // ä¿å­˜å…ƒæ•°æ®
        function saveMetadata() {
            if (currentDocument) {
                currentDocument.title = document.getElementById('doc-title').value;
                currentDocument.description = document.getElementById('doc-description').value;
                currentDocument.category = document.getElementById('doc-category').value;
                currentDocument.draft = document.getElementById('doc-draft').checked;
                
                // æ”¶é›†æ ‡ç­¾
                const tags = Array.from(document.querySelectorAll('.tag')).map(tag => 
                    tag.getAttribute('data-tag')
                );
                currentDocument.tags = tags;
                
                renderDocumentList();
                console.log('å…ƒæ•°æ®å·²ä¿å­˜');
            }
        }

        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            const file = document.getElementById('image-upload').files[0];
            const alt = document.getElementById('image-alt').value;
            
            if (file) {
                // è¿™é‡Œåº”è¯¥ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
                // ç›®å‰ä½¿ç”¨å ä½ç¬¦
                const imagePath = `/images/${file.name}`;
                const markdown = `![${alt}](${imagePath})`;
                insertText(markdown);
                
                // é‡ç½®è¡¨å•
                document.getElementById('image-form').reset();
            }
        }

        // ä¿å­˜æ–‡æ¡£
        async function saveDocument() {
            if (currentDocument) {
                try {
                    const content = document.getElementById('markdown-editor').value;
                    const data = {
                        id: currentDocument.id,
                        title: currentDocument.title,
                        content: content
                    };
                    
                    const response = await fetch(`${API_BASE}/api/documents/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentDocument = result.data;
                        alert('æ–‡æ¡£ä¿å­˜æˆåŠŸï¼');
                        loadDocuments();
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + result.error);
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ–‡æ¡£å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            } else {
                alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºæ–‡æ¡£');
            }
        }

        // å‘å¸ƒæ–‡æ¡£
        async function publishDocument() {
            if (currentDocument) {
                try {
                    await saveDocument(); // å…ˆä¿å­˜
                    
                    const response = await fetch(`${API_BASE}/api/documents/publish`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: currentDocument.id })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentDocument = result.data;
                        alert('æ–‡æ¡£å‘å¸ƒæˆåŠŸï¼');
                        renderDocumentList();
                    } else {
                        alert('å‘å¸ƒå¤±è´¥ï¼š' + result.error);
                    }
                } catch (error) {
                    console.error('å‘å¸ƒæ–‡æ¡£å¤±è´¥:', error);
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            } else {
                alert('è¯·å…ˆé€‰æ‹©æ–‡æ¡£');
            }
        }

        // è‡ªåŠ¨ä¿å­˜
        function autoSave() {
            if (currentDocument && document.getElementById('markdown-editor').value) {
                currentDocument.content = document.getElementById('markdown-editor').value;
                console.log('è‡ªåŠ¨ä¿å­˜å®Œæˆ');
            }
        }

        // åˆ›å»ºæ–°æ–‡æ¡£
        function createNewDocument() {
            const newDoc = {
                id: 'new_' + Date.now(),
                title: 'æ–°å»ºæ–‡æ¡£',
                status: 'draft',
                content: '# æ–°å»ºæ–‡æ¡£\n\nå¼€å§‹ç¼–å†™æ‚¨çš„å†…å®¹...'
            };
            
            currentDocument = newDoc;
            document.getElementById('markdown-editor').value = newDoc.content;
            updatePreview();
            
            // æ·»åŠ åˆ°æ–‡æ¡£åˆ—è¡¨
            documents.unshift(newDoc);
            renderDocumentList();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>

// åˆ é™¤æ•´ä¸ªå‡½æ•°
// åˆ›å»ºæ–°æ–‡æ¡£
function createNewDocument() {
    const newDoc = {
        id: 'new_' + Date.now(),
        title: 'æ–°å»ºæ–‡æ¡£',
        status: 'draft',
        content: '# æ–°å»ºæ–‡æ¡£\n\nå¼€å§‹ç¼–å†™æ‚¨çš„å†…å®¹...'
    };
    
    currentDocument = newDoc;
    document.getElementById('markdown-editor').value = newDoc.content;
    updatePreview();
    
    // æ·»åŠ åˆ°æ–‡æ¡£åˆ—è¡¨
    documents.unshift(newDoc);
    renderDocumentList();
}