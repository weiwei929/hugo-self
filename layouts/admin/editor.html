<!DOCTYPE html>
<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hugo-Self MarkdownÁºñËæëÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e1e8ed;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 1.5em;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .editor-area {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-toolbar {
            padding: 1rem;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background-color: #f3f4f6;
        }

        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-pane, .preview-pane {
            flex: 1;
            overflow: auto;
        }

        .editor-pane {
            border-right: 1px solid #e1e8ed;
        }

        #markdown-editor {
            width: 100%;
            height: 100%;
            border: none;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .preview-pane {
            padding: 1rem;
            background-color: #fafbfc;
        }

        .file-item {
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }

        .file-item:hover {
            background-color: #f3f4f6;
        }

        .file-item.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .file-name {
            font-size: 0.9em;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .status-badge {
            font-size: 0.7em;
            padding: 0.2rem 0.4rem;
            border-radius: 12px;
            background-color: #e5e7eb;
            color: #374151;
        }

        .status-badge.published {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-badge.draft {
            background-color: #fef3c7;
            color: #92400e;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #f0f9ff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            min-width: 400px;
            max-width: 90%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            min-height: 38px;
        }

        .tag {
            background-color: #3b82f6;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tag-remove {
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-pane {
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
            }
        }
    </style>
</head>
<body>
    <!-- Â§¥ÈÉ® -->
    <div class="header">
        <h1>üìù MarkdownÁºñËæëÂô®</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showMetadataModal()">üìã ÂÖÉÊï∞ÊçÆ</button>
            <button class="btn btn-primary" onclick="saveDocument()">üíæ ‰øùÂ≠ò</button>
            <button class="btn btn-success" onclick="publishDocument()">üöÄ ÂèëÂ∏É</button>
            <button class="btn btn-secondary" onclick="logout()">üö™ ÈÄÄÂá∫</button>
            <a href="/admin/" class="btn btn-secondary">‚Üê ËøîÂõû</a>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ -->
    <div class="main-content">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <h3>üìÅ ÊñáÊ°£ÂàóË°®</h3>
            
            <!-- Âà†Èô§Ëøô‰∏§Ë°å -->
            <!-- Ê∑ªÂä†ÂàõÂª∫Êñ∞ÊñáÊ°£ÊåâÈíÆ -->
            <button class="btn btn-primary" onclick="createNewDocument()" style="width: 100%; margin-bottom: 1rem;">üìù ÂàõÂª∫Êñ∞ÊñáÊ°£</button>
            
            <!-- Êñá‰ª∂‰∏ä‰º†Âå∫ -->
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                <p>üì§ ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Êñá‰ª∂</p>
                <p style="font-size: 0.8em; color: #6b7280;">ÊîØÊåÅ .md, .markdown, .txt</p>
                <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                    <div style="background: #e5e7eb; border-radius: 4px; height: 4px; overflow: hidden;">
                        <div id="progress-bar" style="background: #3b82f6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="upload-status" style="font-size: 0.7em; color: #4b5563; margin-top: 0.25rem;">‰∏ä‰º†‰∏≠...</p>
                </div>
            </div>
            <input type="file" id="file-upload" multiple accept=".md,.markdown,.txt" style="display: none;">

            <!-- ÊñáÊ°£ÂàóË°® -->
            <div id="document-list">
                <!-- Âä®ÊÄÅÂä†ËΩΩÊñáÊ°£ÂàóË°® -->
            </div>
        </div>

        <!-- ÁºñËæëÂô®Âå∫Âüü -->
        <div class="editor-area">
            <!-- Â∑•ÂÖ∑Ê†è -->
            <div class="editor-toolbar">
                <button class="toolbar-btn" onclick="insertText('# ')" title="Ê†áÈ¢ò">H1</button>
                <button class="toolbar-btn" onclick="insertText('## ')" title="ÂâØÊ†áÈ¢ò">H2</button>
                <button class="toolbar-btn" onclick="insertText('**', '**')" title="Á≤ó‰Ωì">B</button>
                <button class="toolbar-btn" onclick="insertText('*', '*')" title="Êñú‰Ωì">I</button>
                <button class="toolbar-btn" onclick="insertText('`', '`')" title="‰ª£Á†Å">Code</button>
                <button class="toolbar-btn" onclick="insertText('[', ']()')" title="ÈìæÊé•">üîó</button>
                <button class="toolbar-btn" onclick="showImageModal()" title="ÊèíÂÖ•ÂõæÁâá">üñºÔ∏è</button>
                <button class="toolbar-btn" onclick="insertText('- ')" title="ÂàóË°®">List</button>
                <button class="toolbar-btn" onclick="insertText('> ')" title="ÂºïÁî®">Quote</button>
                <button class="toolbar-btn" onclick="togglePreview()" title="ÂàáÊç¢È¢ÑËßà">üëÅÔ∏è</button>
            </div>

            <!-- ÁºñËæëÂô®ÂÆπÂô® -->
            <div class="editor-container">
                <div class="editor-pane">
                    <textarea id="markdown-editor" placeholder="Âú®Ê≠§ËæìÂÖ•MarkdownÂÜÖÂÆπ..."></textarea>
                </div>
                <div class="preview-pane" id="preview-pane">
                    <p style="color: #6b7280;">È¢ÑËßàÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÖÉÊï∞ÊçÆÊ®°ÊÄÅÊ°Ü -->
    <div id="metadata-modal" class="modal">
        <div class="modal-content">
            <h3>üìã ÊñáÊ°£ÂÖÉÊï∞ÊçÆ</h3>
            <form id="metadata-form">
                <div class="form-group">
                    <label for="doc-title">Ê†áÈ¢ò</label>
                    <input type="text" id="doc-title" required>
                </div>
                <div class="form-group">
                    <label for="doc-description">ÊèèËø∞</label>
                    <textarea id="doc-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="doc-tags">Ê†áÁ≠æ</label>
                    <div class="tag-input" id="tag-input">
                        <input type="text" id="tag-input-field" placeholder="ËæìÂÖ•Ê†áÁ≠æÂêéÊåâÂõûËΩ¶">
                    </div>
                </div>
                <div class="form-group">
                    <label for="doc-category">ÂàÜÁ±ª</label>
                    <select id="doc-category">
                        <option value="">ÈÄâÊã©ÂàÜÁ±ª</option>
                        <option value="ÊäÄÊúØ">ÊäÄÊúØ</option>
                        <option value="ÁîüÊ¥ª">ÁîüÊ¥ª</option>
                        <option value="ÊÄùËÄÉ">ÊÄùËÄÉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="doc-draft"> ‰øùÂ≠ò‰∏∫ËçâÁ®ø
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('metadata-modal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">‰øùÂ≠òÂÖÉÊï∞ÊçÆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÂõæÁâáÊèíÂÖ•Ê®°ÊÄÅÊ°Ü -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h3>üñºÔ∏è ÊèíÂÖ•ÂõæÁâá</h3>
            <form id="image-form">
                <div class="form-group">
                    <label>ÈÄâÊã©ÂõæÁâáÊñá‰ª∂</label>
                    <input type="file" id="image-upload" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="image-alt">ÂõæÁâáÊèèËø∞</label>
                    <input type="text" id="image-alt" placeholder="ÂõæÁâáÁöÑÊõø‰ª£ÊñáÂ≠ó">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('image-modal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">ÊèíÂÖ•ÂõæÁâá</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentDocument = null;
        let documents = [];
        let isPreviewMode = false;
        const API_BASE = 'http://localhost:8081'; // APIÊúçÂä°Âô®Âú∞ÂùÄÔºà‰øÆÂ§ç‰∏∫8081Á´ØÂè£Ôºâ
        const AUTH_KEY = 'hugo_self_auth';

        // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        function checkAuth() {
            const auth = localStorage.getItem(AUTH_KEY);
            if (!auth) {
                redirectToLogin();
                return false;
            }

            try {
                const authData = JSON.parse(auth);
                if (Date.now() >= authData.expiry) {
                    logout(false); // ÈùôÈªòÈÄÄÂá∫
                    return false;
                }
                return true;
            } catch (e) {
                localStorage.removeItem(AUTH_KEY);
                redirectToLogin();
                return false;
            }
        }

        // ÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÈù¢
        function redirectToLogin() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.2em;
                z-index: 10000;
            `;
            overlay.innerHTML = '<div>ÁôªÂΩïÂ∑≤ËøáÊúüÔºåÊ≠£Âú®Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢...</div>';
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1500);
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout(showConfirm = true) {
            if (showConfirm && !confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºüÊú™‰øùÂ≠òÁöÑÂÜÖÂÆπÂ∞Ü‰ºö‰∏¢Â§±ÔºÅ')) {
                return;
            }
            
            // Ê∏ÖÈô§ÊâÄÊúâËÆ§ËØÅÁõ∏ÂÖ≥Êï∞ÊçÆ
            localStorage.removeItem(AUTH_KEY);
            sessionStorage.clear();
            
            // ÊòæÁ§∫ÈÄÄÂá∫ÊàêÂäü‰ø°ÊÅØ
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5em;
                z-index: 10000;
            `;
            overlay.innerHTML = '<div>‚úÖ Â∑≤ÂÆâÂÖ®ÈÄÄÂá∫ÔºåÊ≠£Âú®Ë∑≥ËΩ¨...</div>';
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                window.location.href = '/login/';
            }, 1500);
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            if (!checkAuth()) {
                return;
            }
            
            loadDocuments();
            setupEventListeners();
            
            // Ëá™Âä®‰øùÂ≠ò
            setInterval(autoSave, 30000); // ÊØè30ÁßíËá™Âä®‰øùÂ≠ò
            
            // ÂÆöÊúüÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            setInterval(checkAuth, 60000); // ÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°
        });

        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // Êñá‰ª∂‰∏ä‰º†
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            
            // ÁºñËæëÂô®ÂÜÖÂÆπÂèòÂåñ
            document.getElementById('markdown-editor').addEventListener('input', function() {
                if (!isPreviewMode) {
                    updatePreview();
                }
            });

            // ÊãñÊãΩ‰∏ä‰º†
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // Ê†áÁ≠æËæìÂÖ•
            document.getElementById('tag-input-field').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // ÂÖÉÊï∞ÊçÆË°®ÂçïÊèê‰∫§
            document.getElementById('metadata-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveMetadata();
                closeModal('metadata-modal');
            });

            // ÂõæÁâáË°®ÂçïÊèê‰∫§
            document.getElementById('image-form').addEventListener('submit', function(e) {
                e.preventDefault();
                insertImage();
                closeModal('image-modal');
            });
        }

        // Âä†ËΩΩÊñáÊ°£ÂàóË°®
        async function loadDocuments() {
            try {
                const response = await fetch(`${API_BASE}/api/documents`);
                const result = await response.json();
                
                if (result.success) {
                    documents = result.data;
                    renderDocumentList();
                    // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÊñáÊ°£
                    if (documents.length > 0) {
                        loadDocument(documents[0]);
                    }
                } else {
                    console.error('Âä†ËΩΩÊñáÊ°£Â§±Ë¥•:', result.error);
                    // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                    documents = [
                        { id: 'demo1', title: 'Ê¨¢Ëøé‰ΩøÁî®Hugo-Self', status: 'published', content: '# Ê¨¢Ëøé‰ΩøÁî®Hugo-Self\n\nËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÊñáÊ°£„ÄÇ' },
                        { id: 'demo2', title: 'Êñ∞Âª∫ÊñáÊ°£', status: 'draft', content: '# Êñ∞Âª∫ÊñáÊ°£\n\nÂºÄÂßãÁºñÂÜôÊÇ®ÁöÑÂÜÖÂÆπ...' }
                    ];
                    renderDocumentList();
                    // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÊñáÊ°£
                    if (documents.length > 0) {
                        loadDocument(documents[0]);
                    }
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊñáÊ°£Â§±Ë¥•:', error);
                // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                documents = [
                    { id: 'demo1', title: 'Ê¨¢Ëøé‰ΩøÁî®Hugo-Self', status: 'published', content: '# Ê¨¢Ëøé‰ΩøÁî®Hugo-Self\n\nËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÊñáÊ°£„ÄÇ' },
                    { id: 'demo2', title: 'Êñ∞Âª∫ÊñáÊ°£', status: 'draft', content: '# Êñ∞Âª∫ÊñáÊ°£\n\nÂºÄÂßãÁºñÂÜôÊÇ®ÁöÑÂÜÖÂÆπ...' }
                ];
                renderDocumentList();
                // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÊñáÊ°£
                if (documents.length > 0) {
                    loadDocument(documents[0]);
                }
            }
        }

        // Ê∏≤ÊüìÊñáÊ°£ÂàóË°®
        function renderDocumentList() {
            const listElement = document.getElementById('document-list');
            listElement.innerHTML = '';

            documents.forEach(doc => {
                const item = document.createElement('div');
                item.className = 'file-item';
                if (currentDocument && currentDocument.id === doc.id) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <div class="file-name" title="${doc.title}">${doc.title}</div>
                    <span class="status-badge ${doc.status}">${doc.status === 'published' ? 'Â∑≤ÂèëÂ∏É' : 'ËçâÁ®ø'}</span>
                `;
                
                item.addEventListener('click', () => loadDocument(doc));
                listElement.appendChild(item);
            });
        }

        // Âä†ËΩΩÊñáÊ°£
        function loadDocument(doc) {
            currentDocument = doc;
            document.getElementById('markdown-editor').value = doc.content || '';
            updatePreview();
            renderDocumentList(); // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        }

        // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
        function handleFileUpload(event) {
            const files = event.target.files;
            handleFiles(files);
        }

        // Â§ÑÁêÜÊñá‰ª∂
        async function handleFiles(files) {
            if (files.length === 0) return;
            
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('upload-status');
            
            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
            progressDiv.style.display = 'block';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                
                progressBar.style.width = progress + '%';
                statusText.textContent = `Ê≠£Âú®Â§ÑÁêÜ: ${file.name} (${i + 1}/${files.length})`;
                
                if (file.type === 'text/markdown' || file.type === 'text/plain' || file.name.endsWith('.md')) {
                    try {
                        const content = await file.text();
                        
                        // ÈÄöËøáAPIÂØºÂÖ•ÊñáÊ°£
                        const response = await fetch(`${API_BASE}/api/documents/import`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filename: file.name,
                                content: content
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            successCount++;
                            console.log(`ÊñáÊ°£ "${file.name}" ‰∏ä‰º†ÊàêÂäü`);
                        } else {
                            errorCount++;
                            console.error(`ÊñáÊ°£ "${file.name}" ‰∏ä‰º†Â§±Ë¥•: ${result.error}`);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
                    }
                } else {
                    errorCount++;
                    console.warn(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã: ${file.name}`);
                }
            }
            
            // ÂÆåÊàêÂêéÊòæÁ§∫ÁªìÊûú
            progressBar.style.width = '100%';
            if (errorCount === 0) {
                statusText.textContent = `‚úÖ ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†ÊàêÂäü! (ÊàêÂäü: ${successCount}‰∏™)`;
                statusText.style.color = '#065f46';
            } else if (successCount === 0) {
                statusText.textContent = `‚ùå ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†Â§±Ë¥•! (Â§±Ë¥•: ${errorCount}‰∏™)`;
                statusText.style.color = '#dc2626';
            } else {
                statusText.textContent = `‚ö†Ô∏è ÈÉ®ÂàÜÊàêÂäü (ÊàêÂäü: ${successCount}‰∏™, Â§±Ë¥•: ${errorCount}‰∏™)`;
                statusText.style.color = '#d97706';
            }
            
            // ÈáçÊñ∞Âä†ËΩΩÊñáÊ°£ÂàóË°®
            if (successCount > 0) {
                await loadDocuments();
            }
            
            // 3ÁßíÂêéÈöêËóèËøõÂ∫¶Êù°
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
                statusText.style.color = '#4b5563';
            }, 3000);
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
            document.getElementById('file-upload').value = '';
        }

        // Êõ¥Êñ∞È¢ÑËßà
        function updatePreview() {
            const content = document.getElementById('markdown-editor').value;
            const preview = document.getElementById('preview-pane');
            
            // ÁÆÄÂçïÁöÑMarkdownËΩ¨HTML (ÂÆûÈôÖÈ°πÁõÆ‰∏≠Âª∫ËÆÆ‰ΩøÁî®‰∏ìÈó®ÁöÑÂ∫ì)
            let html = content
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            if (html) {
                preview.innerHTML = '<p>' + html + '</p>';
            } else {
                preview.innerHTML = '<p style="color: #6b7280;">È¢ÑËßàÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫...</p>';
            }
        }

        // ÊèíÂÖ•ÊñáÊú¨
        function insertText(before, after = '') {
            const editor = document.getElementById('markdown-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            
            const newText = before + selectedText + after;
            editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
            
            // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆ
            const newCursorPos = start + before.length + selectedText.length;
            editor.setSelectionRange(newCursorPos, newCursorPos);
            editor.focus();
            
            updatePreview();
        }

        // ÂàáÊç¢È¢ÑËßàÊ®°Âºè
        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            const editorPane = document.querySelector('.editor-pane');
            const previewPane = document.querySelector('.preview-pane');
            
            if (isPreviewMode) {
                editorPane.style.display = 'none';
                previewPane.style.flex = '1';
            } else {
                editorPane.style.display = 'block';
                previewPane.style.flex = '1';
            }
        }

        // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMetadataModal() {
            if (currentDocument) {
                document.getElementById('doc-title').value = currentDocument.title || '';
                document.getElementById('doc-description').value = currentDocument.description || '';
                // Âä†ËΩΩÊ†áÁ≠æÂíåÂàÜÁ±ª...
            }
            showModal('metadata-modal');
        }

        function showImageModal() {
            showModal('image-modal');
        }

        // Ê∑ªÂä†Ê†áÁ≠æ
        function addTag(tagName) {
            if (tagName && !document.querySelector(`[data-tag="${tagName}"]`)) {
                const tagInput = document.getElementById('tag-input');
                const inputField = document.getElementById('tag-input-field');
                
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.setAttribute('data-tag', tagName);
                tag.innerHTML = `${tagName} <span class="tag-remove" onclick="removeTag('${tagName}')">√ó</span>`;
                
                tagInput.insertBefore(tag, inputField);
            }
        }

        // ÁßªÈô§Ê†áÁ≠æ
        function removeTag(tagName) {
            const tag = document.querySelector(`[data-tag="${tagName}"]`);
            if (tag) {
                tag.remove();
            }
        }

        // ‰øùÂ≠òÂÖÉÊï∞ÊçÆ
        function saveMetadata() {
            if (currentDocument) {
                currentDocument.title = document.getElementById('doc-title').value;
                currentDocument.description = document.getElementById('doc-description').value;
                currentDocument.category = document.getElementById('doc-category').value;
                currentDocument.draft = document.getElementById('doc-draft').checked;
                
                // Êî∂ÈõÜÊ†áÁ≠æ
                const tags = Array.from(document.querySelectorAll('.tag')).map(tag => 
                    tag.getAttribute('data-tag')
                );
                currentDocument.tags = tags;
                
                renderDocumentList();
                console.log('ÂÖÉÊï∞ÊçÆÂ∑≤‰øùÂ≠ò');
            }
        }

        // ÊèíÂÖ•ÂõæÁâá
        function insertImage() {
            const file = document.getElementById('image-upload').files[0];
            const alt = document.getElementById('image-alt').value;
            
            if (file) {
                // ËøôÈáåÂ∫îËØ•‰∏ä‰º†ÂõæÁâáÂà∞ÊúçÂä°Âô®
                // ÁõÆÂâç‰ΩøÁî®Âç†‰ΩçÁ¨¶
                const imagePath = `/images/${file.name}`;
                const markdown = `![${alt}](${imagePath})`;
                insertText(markdown);
                
                // ÈáçÁΩÆË°®Âçï
                document.getElementById('image-form').reset();
            }
        }

        // ‰øùÂ≠òÊñáÊ°£
        async function saveDocument() {
            if (currentDocument) {
                try {
                    const content = document.getElementById('markdown-editor').value;
                    const data = {
                        id: currentDocument.id,
                        title: currentDocument.title,
                        content: content
                    };
                    
                    const response = await fetch(`${API_BASE}/api/documents/save`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentDocument = result.data;
                        alert('ÊñáÊ°£‰øùÂ≠òÊàêÂäüÔºÅ');
                        loadDocuments();
                    } else {
                        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + result.error);
                    }
                } catch (error) {
                    console.error('‰øùÂ≠òÊñáÊ°£Â§±Ë¥•:', error);
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                }
            } else {
                alert('ËØ∑ÂÖàÈÄâÊã©ÊàñÂàõÂª∫ÊñáÊ°£');
            }
        }

        // ÂèëÂ∏ÉÊñáÊ°£
        async function publishDocument() {
            if (currentDocument) {
                try {
                    await saveDocument(); // ÂÖà‰øùÂ≠ò
                    
                    const response = await fetch(`${API_BASE}/api/documents/publish`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: currentDocument.id })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentDocument = result.data;
                        alert('ÊñáÊ°£ÂèëÂ∏ÉÊàêÂäüÔºÅ');
                        renderDocumentList();
                    } else {
                        alert('ÂèëÂ∏ÉÂ§±Ë¥•Ôºö' + result.error);
                    }
                } catch (error) {
                    console.error('ÂèëÂ∏ÉÊñáÊ°£Â§±Ë¥•:', error);
                    alert('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                }
            } else {
                alert('ËØ∑ÂÖàÈÄâÊã©ÊñáÊ°£');
            }
        }

        // Ëá™Âä®‰øùÂ≠ò
        function autoSave() {
            if (currentDocument && document.getElementById('markdown-editor').value) {
                currentDocument.content = document.getElementById('markdown-editor').value;
                console.log('Ëá™Âä®‰øùÂ≠òÂÆåÊàê');
            }
        }

        // ÂàõÂª∫Êñ∞ÊñáÊ°£
        function createNewDocument() {
            const newDoc = {
                id: 'new_' + Date.now(),
                title: 'Êñ∞Âª∫ÊñáÊ°£',
                status: 'draft',
                content: '# Êñ∞Âª∫ÊñáÊ°£\n\nÂºÄÂßãÁºñÂÜôÊÇ®ÁöÑÂÜÖÂÆπ...'
            };
            
            currentDocument = newDoc;
            document.getElementById('markdown-editor').value = newDoc.content;
            updatePreview();
            
            // Ê∑ªÂä†Âà∞ÊñáÊ°£ÂàóË°®
            documents.unshift(newDoc);
            renderDocumentList();
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>

// Âà†Èô§Êï¥‰∏™ÂáΩÊï∞
// ÂàõÂª∫Êñ∞ÊñáÊ°£
function createNewDocument() {
    const newDoc = {
        id: 'new_' + Date.now(),
        title: 'Êñ∞Âª∫ÊñáÊ°£',
        status: 'draft',
        content: '# Êñ∞Âª∫ÊñáÊ°£\n\nÂºÄÂßãÁºñÂÜôÊÇ®ÁöÑÂÜÖÂÆπ...'
    };
    
    currentDocument = newDoc;
    document.getElementById('markdown-editor').value = newDoc.content;
    updatePreview();
    
    // Ê∑ªÂä†Âà∞ÊñáÊ°£ÂàóË°®
    documents.unshift(newDoc);
    renderDocumentList();
}